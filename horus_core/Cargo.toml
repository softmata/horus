[package]
name = "horus_core"
version = "0.1.7"
edition = "2021"

[lib]
name = "horus_core"
crate-type = ["rlib", "cdylib", "staticlib"]

[dependencies]
log = "0.4"
libc = "0.2"
memmap2 = "0.9"
paste = "1.0"  # For macro identifier concatenation
core_affinity = "0.8"  # CPU core pinning
tempfile = "3.0"
crossbeam = "0.8"
once_cell = "1.19"
num_cpus = "1.16"
serde.workspace = true
serde_json.workspace = true
serde_yaml = { package = "serde_yaml_ng", version = "0.10" }
regex = "1.10"
toml = "0.8"
bincode = "1.3"
bytemuck = { workspace = true }
bumpalo = { version = "3.14", features = ["collections"] }
ctrlc = "3.4"
colored = "2.0"
tokio = { version = "1.0", features = ["full"] }
rayon = "1.10"
parking_lot = "0.12"
cranelift = "0.110"
cranelift-jit = "0.110"
cranelift-module = "0.110"
cranelift-native = "0.110"
chrono = { version = "0.4", features = ["serde", "std"] }
uuid = { version = "1.0", features = ["v4", "serde"] }
dirs = "5.0"
lazy_static = "1.4"
flate2 = "1.0"  # Compression for cloud recording
sha2 = "0.10"   # SHA256 checksums for model verification

# Error handling
thiserror = "1.0"
anyhow = "1.0"

# TLS/Security (optional)
rustls = { version = "0.23", optional = true }
tokio-rustls = { version = "0.26", optional = true }
rustls-pemfile = { version = "2.1", optional = true }
rcgen = { version = "0.13", optional = true }  # For self-signed certs
x509-parser = { version = "0.16", optional = true }  # Certificate parsing for validity checks
hex = { version = "0.4", optional = true }  # Hex encoding for certificate fingerprints

# QUIC transport (optional)
quinn = { version = "0.11", optional = true }

# Macros (optional)
horus_macros = { path = "../horus_macros", optional = true }

# HTTP client for model downloading and Husarnet API (optional)
reqwest = { version = "0.11", features = ["blocking", "json"], optional = true }

# Cloud storage providers (optional)
aws-sdk-s3 = { version = "1.120", optional = true }
aws-config = { version = "1.8", optional = true }
google-cloud-storage = { version = "0.20", optional = true }
azure_storage = { version = "0.20", optional = true }
azure_storage_blobs = { version = "0.20", optional = true }
futures = { version = "0.3", optional = true }

# Zenoh transport (optional)
zenoh = { version = "1.0", optional = true }

# mDNS service discovery (optional)
mdns-sd = { version = "0.11", optional = true }

# WebRTC data channels (optional)
webrtc = { version = "0.13", optional = true }
bytes = { version = "1.0", optional = true }

# WebSocket signaling server (optional)
tokio-tungstenite = { version = "0.24", optional = true }
dashmap = { version = "6.0", optional = true }  # Concurrent hashmap for peer tracking

# Dynamic plugin loading (optional)
libloading = { workspace = true, optional = true }

# Serialization formats for Zenoh (optional)
cdr-encoding = { version = "0.10", optional = true }  # ROS2/DDS CDR format
byteorder = { version = "1.5", optional = true }      # For CDR byte order
rmp-serde = { version = "1.3", optional = true }      # MessagePack format

# Platform-specific: Windows shared memory
[target.'cfg(windows)'.dependencies]
windows-sys = { version = "0.52", features = ["Win32_Foundation", "Win32_System_Memory", "Win32_Security", "Win32_System_Threading"] }

# Platform-specific: Linux io_uring (optional)
[target.'cfg(target_os = "linux")'.dependencies]
io-uring = { version = "0.6", optional = true }

[dev-dependencies]
criterion = { version = "0.5", features = ["html_reports"] }
rand = "0.8"

# Benchmarks are currently disabled
# Uncomment to enable:
# [[bench]]
# name = "cuda_ipc_benchmark"
# harness = false
# required-features = ["cuda"]

# [[bench]]
# name = "network_bench"
# harness = false

[features]
default = ["macros"]
macros = ["horus_macros"]
tls = ["rustls", "tokio-rustls", "rustls-pemfile", "rcgen", "x509-parser", "hex"]
quic = ["quinn", "rustls", "rcgen"]
io-uring-net = ["io-uring"]
ultra-low-latency = ["io-uring-net"]  # Enable io_uring for lowest latency
network-v2 = []  # Enable all network v2 optimizations
cuda = []  # Enable CUDA IPC for cross-process GPU memory sharing

# Cloud storage backends
cloud-s3 = ["aws-sdk-s3", "aws-config", "futures"]
cloud-gcs = ["google-cloud-storage", "futures"]
cloud-azure = ["azure_storage", "azure_storage_blobs", "futures"]
cloud-all = ["cloud-s3", "cloud-gcs", "cloud-azure"]  # Enable all cloud providers

# Zenoh transport for multi-robot and ROS2 interop
zenoh-transport = ["zenoh", "rmp-serde"]  # Includes MessagePack support
zenoh-ros2 = ["zenoh-transport", "cdr-encoding", "byteorder"]  # Zenoh with ROS2 CDR compatibility (use horus_ros2_bridge crate for ROS2 protocols)

# Dynamic driver plugin loading
dynamic-plugins = ["libloading"]

# mDNS/DNS-SD for zero-config networking
mdns = ["mdns-sd"]

# WebRTC data channels for browser connectivity and P2P
webrtc-transport = ["webrtc", "bytes"]

# Built-in signaling server for P2P connection coordination
signaling-server = ["tokio-tungstenite", "dashmap", "futures"]

# Husarnet VPN integration for WAN connectivity
husarnet = ["reqwest"]
